<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>RTC-Snap! interface</title>
    <script type="text/javascript" src="/jquery-3.0.0.min.js"></script>
    <script type="text/javascript" src="/snap/rtc_ws.js"></script>

    <script type="text/javascript">
        var uri = "ws://" + location.host + "/ws/rpc";
        var rtc = new RtcWs();

        function init() {
            $("[data-name='message']").keypress(press);
            rtc.open(uri);
            rtc.waitOpened(rtc);

            chat('Connect to server');
            getProjectList();
        }

        function press(event) {
            if (event && event.which == 13) {
                var message = $("[data-name='message']").val();
                  chat(message);
                  eval(message);
                  //rtc.send(message);
                  $("[data-name='message']").val("");
            }
        }

        function chat(message) {
            var chats = $("[data-name='chat']").find("div");
            while (chats.length >= 25) {
                chats = chats.last().remove();
            }
            var msgtag = $("<div>").text(message);
            $("[data-name='chat']").prepend(msgtag);
            return message;
        }

        function getProjectList() {
            var res = rtc.call("projects", updateProjectList);
            if(res == -2){
               setTimeout(getProjectList, 100);
            }
        }

        function updateProjectList(lst) {

            if(!lst) { return; }
            console.log(lst);
            var lstview = '<table>';
            var w = 5;
            var h = lst.length / w;
            var n;

            for(var i=0; i< h ; i++){
              n = i*w;
              lstview += '<tr>';
              for(var j=0; j< w && lst.length > n+j; j++){
                lstview += '<td>'+ mk_icon(lst[n+j]) +'</td>';
              }
              lstview += '</tr>';
            }
            lstview += '</table>';

            $("[data-name='project-list']").html(lstview);
        }

        function mk_icon(name){
          var icon;
           icon  = '<p style="position: relative;">';
           icon += '<a target="_new" href="/snap/snap.html#open:projects/'+name+'/project.xml">';
           icon += '<img src="images/Blue.png" alt="'+name+'" /><br />';
           icon += '</a>';
           icon += ' <span style="position: absolute; top: 15px; left: 15px; width: 70px;">'+name+'</span>';
           icon += '</p>';
          return icon;
        }

        $(init);
          
    </script>
</head>
<body>
  <div style="width:45%;position:absolute-block;top:0px;left:0%;">
    Command:<input type="text" data-name="message" size="20" />
    <hr />
    <div data-name="chat"></div>

  </div>

  <div style="width:45%;position:absolute;top:0px;left:50%;">
  <h2>List of Projects</h2>
  <button onClick="getProjectList();">Update List</button>
  <button onClick="rtc.check_result();">Check</button>
    <hr />
    <div data-name="project-list"></div>
  </div>

</body>
</html>

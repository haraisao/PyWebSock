<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>RTC-Snap! interface</title>
    <script type="text/javascript" src="js/jquery-3.0.0.min.js"></script>
    <script type="text/javascript" src="js/rtc_ws.js"></script>

    <script type="text/javascript">
        var rtc = new RtcWs();
        var max_lines = 25;
        var selectedRtc = "";
        var selectedRtcItm = null;

        function init() {
          selectDataTypeHide();
          rtc.open('rtmgr');
          rtc.waitOpened(rtc);
          getRtcList();
        }

        /**** Commands ***/
        function getRtcList() {
          rtc.getRtcList(updateRtcList, 250);
        }

        function updateRtcList(lst) {
          lstview = mkRtcList(lst);
          $("[data-name='rtc-list']").html(lstview);

          if( selectedRtcItm ){
            selectedRtcItm = document.getElementById(selectedRtc);
            selectedRtcItm.style.backgroundColor='black';
            selectedRtcItm.style.color='white';
          }
        }

        function mkRtcList(lst){
          if(!lst) { return ""; }
          var h = lst.length;
          var n;

          var lstview = '<table>';
          for(var i=0; i< h ; i++){
            n=i+1
            lstview += '<tr>';
            lstview += '<td>['+n+']:'+ mk_rtc_item(lst[i]) +'</td>';
            lstview += '</tr>';
          }
          lstview += '</table>';
          return lstview;
        }

        function mk_rtc_item(prof){
          var itm;
          itm="";
          itm += '<span id="'+prof.name+'" onClick="selectRtc(\''+prof.name+'\', this);">';
          itm += prof.name
          itm += '</span>';
          console.log(prof);
          for(p in  prof.in_port){
            itm += "<br>&nbsp;&nbsp;-> "+prof.in_port[p].name +"("+prof.in_port[p].data_type+")";
          }

          for(p in  prof.out_port){
            itm += "<br>&nbsp;&nbsp;&nbsp;&nbsp; "+prof.out_port[p].name +"("+prof.out_port[p].data_type+") ->";
          }

          return itm;
        }

        function selectRtc(name, itm){
          if (selectedRtcItm){
            selectedRtcItm.style.backgroundColor='white';
            selectedRtcItm.style.color='black';
          }
          
          selectedRtc = name;
          rtc.setCurrentRtc(name);
          document.getElementById('SelectedRtcName').value=name;
          selectedRtcItm = itm;
          selectedRtcItm.style.backgroundColor='black';
          selectedRtcItm.style.color='white';
        }


        function addDataPort(tid, nid, dtid){
          var typ,name, dtype;

          typ = document.getElementById(tid).value;
          name = document.getElementById(nid).value;
          dtype = document.getElementById(dtid).value;
          if (selectedRtcItm == null || typ == "" || name == "" ){
            alert("Error in addDataPort");
            return;
          }
          rtc.addDataPort(typ, name, dtype);
          getRtcList();
        }

        function deleteDataPort( nid ){
          var name;
          name = document.getElementById(nid).value;
          if (selectedRtcItm == null || name == "" ){
            alert("Error in deleteDataPort");
            return;
          }
          rtc.deleteDataPort(name);
          getRtcList();
                
        }

        function selectDataType(){
          document.getElementById('DataType').value = document.getElementById('DataTypeSel').value;
          document.getElementById('DataTypeSel').style.display='none';
        }

        function selectDataTypeShow(){
          document.getElementById('DataTypeSel').style.display='block';
        }

        function selectDataTypeHide(){
          document.getElementById('DataTypeSel').style.display='none';
        }

        /*

         */
        function activateRtc(){
          if (selectedRtcItm == null){
            alert("Error in activateRtc");
            return;
          }
          rtc.activateRtc();
        }

        function deactivateRtc(){
          if (selectedRtcItm == null){
            alert("Error in activateRtc");
            return;
          }
          rtc.deactivateRtc();
        }


        function open_snap(){
          if( selectedRtcItm ){
            window.open("snap/snap.html#open:projects/rtc/project.xml");
          }else{
            alert("No rt-component selected.");
          }

        }


        function exit() {
          rtc.exit();
          $("[data-name='rtc-list']").html("");
          $("#menu").html("Server closed...");
        }

        function createRtc() {
          rtc.createRtc();
          getRtcList();
        }
        /** call initialize **/
        $(init);
          
    </script>
</head>
<body>
  <h2>List of Rtcs</h2>
   <div id="menu">
    <button onClick="getRtcList();">Update List</button>
    <button onClick="createRtc();">CreateRtc</button> | 
    <button onClick="exit();">Exit Server</button>
   </div>
  <br>
   <div data-name="rtc-edit">
  Selected Rtc: <input type="text" size="30" id="SelectedRtcName" value="" disabled="disabled">
  <h4>Port manager</h4>
 
  <table>
  <tr>
   <td>
     <select id="PortType" size="2">
     <option value="in" selected>InPort </option>
     <option value="out">OutPort </option>
     </select>
   </select>
 </td>
 <td>
   <input type="text" id="PortName" value="" size="10" />
 </td>
 <td>
   <input type="text" id="DataType" value="TimedString" size="15"/>
 </td>
 <td>
   <button onClick="selectDataTypeShow();">>></button>
 </td>
 <td>
   <select id="DataTypeSel" onChange="selectDataType()" >
     <option value=""></option>
     <option value="TimedLong">TimedLong</option>
     <option value="TimedString">TimedString</option>
   </select>
 </td>
 </tr>
 </table>
    <button onClick="addDataPort('PortType', 'PortName', 'DataType');">AddDataPort</button>
    <button onClick="deleteDataPort('PortName');">deleteDataPort</button>
  <p>
    <button onClick="activateRtc();">activateRtc</button>
    <button onClick="deactivateRtc();">deactivateRtc</button>

  <h4>Core logic edit by Snap!</h4>
    <button onClick="open_snap();">Open Snap!</button>
  
    <hr />
   <h3>Components</h3>
   <div data-name="rtc-list"></div>

</body>
</html>
